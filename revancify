#!/usr/bin/bash

cd "$HOME" || exit 1

SRC="$HOME/Revancify"

DATA="$SRC/data"
[ -e "$DATA" ] || mkdir -p "$DATA"

BIN="$PREFIX/bin"

HELP="revancify

Usage: revancify [OPTION]

Options:
-u:  Disable Update Check
-r:  Disable Root access
-v:  Print current version
-h:  Print help statement"

while getopts ":urvh" OPT 2> /dev/null; do
    case $OPT in
        u)
            INTERNET_ACCESS=false
            ;;
        r)
            ROOT_ACCESS=false
            ;;
        v)
            source "$SRC/.info"
            echo "$VERSION"
            exit
            ;;
        h)
            echo -e "$HELP"
            exit
            ;;
        ?)
            echo -e "Invalid option specified: -${OPTARG}"
            echo -e "$HELP"
            exit 1
            ;;
    esac
done

terminate() {
    killall -9 curl &> /dev/null
    killall -9 wget &> /dev/null
    clear
    echo "Script terminated !!"
    tput cnorm
    exit 1
}
trap terminate SIGTERM SIGINT SIGABRT

installDependencies() {
    clear

    echo "Installing dependencies..."

    ARCH=$(getprop ro.product.cpu.abi)

    [ -e "$HOME/storage" ] || termux-setup-storage

    pkg update -y -o Dpkg::Options::="--force-confnew" || return 1

    pkg install openjdk-21 wget ncurses-utils dialog pup jq unzip -y -o Dpkg::Options::="--force-confnew" || return 1

    sed -i '/allow-external-apps/s/# //' "$HOME/.termux/termux.properties"

    [ ! -e "$DATA/aapt2" ] && wget "https://github.com/decipher3114/binaries/releases/latest/download/aapt2_$ARCH" -O "$DATA/aapt2" && chmod +x "$DATA/aapt2"

    if [ ! -e "$DATA/ApkEditor.jar" ]; then 
        readarray -t RESPONSE < <(curl -s "https://api.github.com/repos/REAndroid/APKEditor/releases/latest" | jq -r '.assets[0] | .browser_download_url, .size')
        wget "${RESPONSE[0]}" -O "$DATA/ApkEditor.jar"
        [ "${RESPONSE[1]}" != "$(stat -c%s "$DATA/ApkEditor.jar")" ] && \
            rm "$DATA/ApkEditor.jar" && \
            return 1
    fi

    echo "Dependencies installed successfully."

    return 0
}

if [ -e "$DATA/aapt2" ] && \
    [ -e "$DATA/ApkEditor.jar" ] && \
    bins=$(ls "$BIN") && \
    grep -q java <<< "$bins" && \
    grep -q wget <<< "$bins" && \
    grep -q tput <<< "$bins" && \
    grep -q dialog <<< "$bins" && \
    grep -q pup <<< "$bins" && \
    grep -q jq <<< "$bins" && \
    grep -q unzip <<< "$bins" && \
    [ -e "$BIN/revancify" ] &> /dev/null && \
    [ -e "$HOME/storage" ] &> /dev/null\
; then
    :
else
    if ping -c 1 google.com &> /dev/null; then
        if ! installDependencies; then
            echo "Dependencies not installed !!"
            exit 1
        fi
    else
        echo -e "Dependencies not installed !!\nRun again with internet connection."
        exit 1
    fi
fi

fetchSrc() {
    [ -e "$SRC/.info" ] && source "$SRC/.info"

    [ "$INTERNET_ACCESS" == false ] && return

    TAG=$(curl -s 'https://api.github.com/repos/decipher3114/Revancify/releases/latest' 2> /dev/null | jq -r '.tag_name')

    [ "$TAG" == "$VERSION" ] && return
    
    wget -qc "https://api.github.com/repos/decipher3114/Revancify/zipball/$TAG" -O "$TAG"
    if [ -e "$TAG" ]; then
        unzip -qqo "$TAG" &> /dev/null
        rm "$TAG" &> /dev/null
        mv -f decipher3114*/* decipher3114*/.* "$SRC/" &> /dev/null
        rm -rf decipher3114* &> /dev/null
        cp -f "$SRC/revancify" "$BIN/revancify"
        chmod +x "$BIN/revancify"
        echo -e "Revancify $TAG is now available.\nRun 'revancify -h' for help."
        exit
    else
        echo -e "Unable to fetch Revancify $TAG !!\nPlease try again."
        exit 1
    fi
}

fetchSrc

if [ "$ROOT_ACCESS" != false ] && su -c 'exit' &> /dev/null ; then
    ROOT_ACCESS=true
else
    ROOT_ACCESS=false
fi

cd "$DATA" &> /dev/null || exit 1

tput civis

bash "$SRC/main.sh" "$ROOT_ACCESS"
EXIT_CODE=$?

tput cnorm
clear

exit "$EXIT_CODE"
